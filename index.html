<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendly Link Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#006BFF',
                        'primary-dark': '#0055cc',
                        'secondary': '#4F46E5',
                        'dark': '#1E293B',
                        'light': '#F8FAFC'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f0ff 100%);
            min-height: 100vh;
        }
        
        .card {
            box-shadow: 0 10px 25px -5px rgba(0,107,255,0.1);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .link-item {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .link-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-left-color: #006BFF;
        }
        
        .pattern-tag {
            font-size: 0.75rem;
            background-color: #EDF2FF;
            color: #006BFF;
        }
        
        .btn-copy:hover {
            background-color: #e6f0ff;
        }
        
        .tab-button {
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background-color: #006BFF;
            color: white;
        }
        
        .tab-button:not(.active) {
            background-color: #f1f5f9;
            color: #64748b;
        }
        
        .file-upload-area {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        
        .file-upload-area.dragover {
            border-color: #006BFF;
            background-color: #f0f7ff;
        }
        
        .bulk-results-table {
            max-height: 500px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50 py-8 px-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-dark mb-3">Find Calendly Links</h1>
            <p class="text-gray-600 max-w-xl mx-auto">Enter a prospect's information or upload a CSV to discover their active Calendly scheduling pages (dedicated to GB)</p>
        </header>
        
        <!-- Mode Selector -->
        <div class="mb-8">
            <div class="flex justify-center">
                <div class="bg-white rounded-lg p-1 shadow-sm">
                    <button id="singleTab" class="tab-button active px-6 py-2 rounded-md font-medium transition">
                        <i class="fas fa-user mr-2"></i>Single Search
                    </button>
                    <button id="bulkTab" class="tab-button px-6 py-2 rounded-md font-medium transition">
                        <i class="fas fa-upload mr-2"></i>Bulk Upload
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Card -->
        <div class="card bg-white mb-8">
            <!-- Single Search Form -->
            <div id="singleForm" class="p-6 md:p-8 border-b">
                <form id="searchForm">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">First Name<span class="text-red-500">*</span></label>
                            <input type="text" id="firstName" placeholder="John" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
                        </div>
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Last Name<span class="text-red-500">*</span></label>
                            <input type="text" id="lastName" placeholder="Doe" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
                        </div>
                    </div>
                    <div class="mb-8">
                        <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Company Name <span class="text-gray-500">(optional)</span></label>
                        <input type="text" id="companyName" placeholder="Acme Inc" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none transition">
                    </div>
                    <button id="searchBtn" type="submit" class="w-full bg-primary hover:bg-primary-dark text-white font-medium py-3 px-6 rounded-lg transition flex items-center justify-center">
                        <span id="btnText">Find Calendly Links</span>
                        <span id="spinner" class="ml-2 hidden">
                            <i class="fas fa-spinner spin"></i>
                        </span>
                    </button>
                </form>
            </div>
            
            <!-- Bulk Upload Form -->
            <div id="bulkForm" class="hidden p-6 md:p-8 border-b">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload CSV File</label>
                    <div id="fileUploadArea" class="file-upload-area rounded-lg p-8 text-center cursor-pointer">
                        <div id="uploadPrompt">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                            <p class="text-lg font-medium text-gray-700 mb-1">Drop your CSV file here or click to browse</p>
                            <p class="text-sm text-gray-500 mb-4">Maximum file size: 10MB</p>
                            <p class="text-xs text-gray-400">Required columns: firstname, lastname (company is optional)</p>
                        </div>
                        <div id="fileInfo" class="hidden">
                            <i class="fas fa-file-csv text-4xl text-green-500 mb-4"></i>
                            <p id="fileName" class="text-lg font-medium text-gray-700 mb-1"></p>
                            <p id="fileSize" class="text-sm text-gray-500 mb-2"></p>
                            <p id="recordCount" class="text-sm text-green-600"></p>
                        </div>
                    </div>
                    <input type="file" id="csvFile" accept=".csv" class="hidden">
                </div>
                <button id="bulkSearchBtn" type="button" disabled class="w-full bg-gray-400 text-white font-medium py-3 px-6 rounded-lg transition flex items-center justify-center">
                    <span id="bulkBtnText">Upload a CSV file to start</span>
                    <span id="bulkSpinner" class="ml-2 hidden">
                        <i class="fas fa-spinner spin"></i>
                    </span>
                </button>
            </div>
            
            <!-- Progress Section -->
            <div id="progressSection" class="hidden p-6 border-b">
                <div class="flex justify-between items-center mb-2">
                    <span id="progressText" class="text-sm font-medium text-gray-700">Testing URLs...</span>
                    <span id="progressFraction" class="text-sm font-medium text-gray-500">0/0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div id="progressBar" class="progress-bar bg-primary" style="width: 0%"></div>
                </div>
                <div id="bulkProgressDetails" class="hidden text-xs text-gray-500">
                    <span id="currentProspect"></span> â€¢ <span id="prospectProgress"></span>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="resultsSection" class="hidden p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Results</h3>
                    <div class="flex items-center gap-4">
                        <button id="exportBtn" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                            <i class="fas fa-download mr-2"></i>Export Results
                        </button>
                        <span id="resultsTime" class="text-sm text-gray-500"></span>
                    </div>
                </div>
                
                <!-- Single Results -->
                <div id="singleResults" class="space-y-3">
                    <!-- Single search results will appear here -->
                </div>
                
                <!-- Bulk Results -->
                <div id="bulkResults" class="hidden">
                    <div class="bulk-results-table border rounded-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="text-left py-3 px-4 font-medium text-gray-900">Name</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-900">Company</th>
                                    <th class="text-left py-3 px-4 font-medium text-gray-900">Found Links</th>
                                    <th class="text-center py-3 px-4 font-medium text-gray-900">Status</th>
                                </tr>
                            </thead>
                            <tbody id="bulkResultsBody">
                                <!-- Bulk results will appear here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div id="emptyResults" class="py-8 text-center">
                    <div class="bg-gray-50 rounded-full p-3 w-16 h-16 mx-auto mb-4">
                        <i class="fas fa-link text-3xl text-gray-400"></i>
                    </div>
                    <h4 class="text-lg font-medium text-gray-700 mb-1">No active Calendly links found</h4>
                    <p class="text-gray-500">We couldn't find any valid scheduling pages for this prospect.</p>
                </div>
            </div>
        </div>
        
        <!-- Info Section -->
        <div class="bg-blue-50 rounded-xl p-6 mb-10">
            <h3 class="font-semibold text-lg text-gray-800 mb-3 flex items-center">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i> How It Works
            </h3>
            <ul class="space-y-2 text-gray-600">
                <li class="flex items-start">
                    <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                    <span>Single: Enter first and last name (company is optional)</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                    <span>Bulk: Upload CSV with firstname, lastname, company (optional) columns</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                    <span>We generate and test 50+ possible URL patterns per prospect</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                    <span>Each link is validated using content analysis (HTTP 200 doesn't mean valid!)</span>
                </li>
            </ul>
        </div>
        
        <!-- Footer -->
        <footer class="text-center text-gray-500 text-sm">
            <p>Calendly Link Finder â€¢ Made for BD pros</p>
        </footer>
    </div>
    
    <script>
        // DOM Elements
        const singleTab = document.getElementById('singleTab');
        const bulkTab = document.getElementById('bulkTab');
        const singleForm = document.getElementById('singleForm');
        const bulkForm = document.getElementById('bulkForm');
        const searchForm = document.getElementById('searchForm');
        const searchBtn = document.getElementById('searchBtn');
        const btnText = document.getElementById('btnText');
        const spinner = document.getElementById('spinner');
        const bulkSearchBtn = document.getElementById('bulkSearchBtn');
        const bulkBtnText = document.getElementById('bulkBtnText');
        const bulkSpinner = document.getElementById('bulkSpinner');
        const fileUploadArea = document.getElementById('fileUploadArea');
        const csvFile = document.getElementById('csvFile');
        const uploadPrompt = document.getElementById('uploadPrompt');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const recordCount = document.getElementById('recordCount');
        const progressSection = document.getElementById('progressSection');
        const progressText = document.getElementById('progressText');
        const progressFraction = document.getElementById('progressFraction');
        const progressBar = document.getElementById('progressBar');
        const bulkProgressDetails = document.getElementById('bulkProgressDetails');
        const currentProspect = document.getElementById('currentProspect');
        const prospectProgress = document.getElementById('prospectProgress');
        const resultsSection = document.getElementById('resultsSection');
        const singleResults = document.getElementById('singleResults');
        const bulkResults = document.getElementById('bulkResults');
        const bulkResultsBody = document.getElementById('bulkResultsBody');
        const emptyResults = document.getElementById('emptyResults');
        const resultsTime = document.getElementById('resultsTime');
        const exportBtn = document.getElementById('exportBtn');
        
        // State variables
        let currentMode = 'single';
        let startTime = null;
        let validUrls = [];
        let bulkData = [];
        let bulkResults = [];
        let totalUrls = 0;
        let testedUrls = 0;
        let currentProspectIndex = 0;
        
        // Event Listeners
        singleTab.addEventListener('click', () => switchMode('single'));
        bulkTab.addEventListener('click', () => switchMode('bulk'));
        searchForm.addEventListener('submit', handleSingleSearch);
        bulkSearchBtn.addEventListener('click', handleBulkSearch);
        fileUploadArea.addEventListener('click', () => csvFile.click());
        fileUploadArea.addEventListener('dragover', handleDragOver);
        fileUploadArea.addEventListener('dragleave', handleDragLeave);
        fileUploadArea.addEventListener('drop', handleDrop);
        csvFile.addEventListener('change', handleFileSelect);
        exportBtn.addEventListener('click', exportResults);
        
        // Switch between single and bulk modes
        function switchMode(mode) {
            currentMode = mode;
            
            if (mode === 'single') {
                singleTab.classList.add('active');
                bulkTab.classList.remove('active');
                singleForm.classList.remove('hidden');
                bulkForm.classList.add('hidden');
            } else {
                bulkTab.classList.add('active');
                singleTab.classList.remove('active');
                singleForm.classList.add('hidden');
                bulkForm.classList.remove('hidden');
            }
            
            // Reset results
            resultsSection.classList.add('hidden');
            progressSection.classList.add('hidden');
        }
        
        // Handle drag and drop
        function handleDragOver(e) {
            e.preventDefault();
            fileUploadArea.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            fileUploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }
        
        // Handle file upload
        function handleFile(file) {
            // Validate file
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please upload a CSV file');
                return;
            }
            
            if (file.size > 10 * 1024 * 1024) { // 10MB
                alert('File size must be less than 10MB');
                return;
            }
            
            // Parse CSV
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        alert('Error parsing CSV: ' + results.errors[0].message);
                        return;
                    }
                    
                    // Validate required columns
                    const headers = results.meta.fields.map(field => field.toLowerCase().trim());
                    if (!headers.includes('firstname') || !headers.includes('lastname')) {
                        alert('CSV must contain "firstname" and "lastname" columns');
                        return;
                    }
                    
                    // Process data
                    bulkData = results.data.filter(row => {
                        const firstName = (row.firstname || row.FirstName || row['First Name'] || '').trim();
                        const lastName = (row.lastname || row.LastName || row['Last Name'] || '').trim();
                        return firstName && lastName;
                    }).map(row => ({
                        firstName: (row.firstname || row.FirstName || row['First Name'] || '').trim(),
                        lastName: (row.lastname || row.LastName || row['Last Name'] || '').trim(),
                        company: (row.company || row.Company || row.companyname || row.CompanyName || row['Company Name'] || '').trim()
                    }));
                    
                    if (bulkData.length === 0) {
                        alert('No valid records found in CSV');
                        return;
                    }
                    
                    // Update UI
                    uploadPrompt.classList.add('hidden');
                    fileInfo.classList.remove('hidden');
                    fileName.textContent = file.name;
                    fileSize.textContent = `${(file.size / 1024).toFixed(1)} KB`;
                    recordCount.textContent = `${bulkData.length} prospects loaded`;
                    
                    // Enable search button
                    bulkSearchBtn.disabled = false;
                    bulkSearchBtn.classList.remove('bg-gray-400');
                    bulkSearchBtn.classList.add('bg-primary', 'hover:bg-primary-dark');
                    bulkBtnText.textContent = `Find Links for ${bulkData.length} Prospects`;
                }
            });
        }
        
        // Handle single search
        function handleSingleSearch(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const companyName = document.getElementById('companyName').value.trim();
            
            if (!firstName || !lastName) {
                alert('First name and last name are required');
                return;
            }
            
            startSingleSearch(firstName, lastName, companyName);
        }
        
        // Handle bulk search
        function handleBulkSearch() {
            if (bulkData.length === 0) {
                alert('Please upload a CSV file first');
                return;
            }
            
            startBulkSearch();
        }
        
        // Start single search
        function startSingleSearch(firstName, lastName, companyName) {
            // Reset state
            validUrls = [];
            testedUrls = 0;
            totalUrls = 0;
            
            // UI updates
            btnText.textContent = 'Searching...';
            spinner.classList.remove('hidden');
            searchBtn.disabled = true;
            resultsSection.classList.add('hidden');
            progressSection.classList.remove('hidden');
            bulkProgressDetails.classList.add('hidden');
            singleResults.innerHTML = '';
            bulkResults.classList.add('hidden');
            singleResults.classList.remove('hidden');
            exportBtn.classList.add('hidden');
            
            // Generate and test URLs
            const urlPatterns = generateUrlPatterns(
                firstName.toLowerCase(), 
                lastName.toLowerCase(), 
                companyName.toLowerCase()
            );
            
            totalUrls = urlPatterns.length;
            startTime = new Date();
            
            updateProgress();
            validateUrlsInBatches(urlPatterns, 5, 500, () => finishSingleSearch());
        }
        
        // Start bulk search
        function startBulkSearch() {
            // Reset state
            bulkResults = [];
            currentProspectIndex = 0;
            testedUrls = 0;
            totalUrls = 0;
            
            // Calculate total URLs
            bulkData.forEach(prospect => {
                const patterns = generateUrlPatterns(
                    prospect.firstName.toLowerCase(),
                    prospect.lastName.toLowerCase(),
                    prospect.company.toLowerCase()
                );
                totalUrls += patterns.length;
            });
            
            // UI updates
            bulkBtnText.textContent = 'Searching...';
            bulkSpinner.classList.remove('hidden');
            bulkSearchBtn.disabled = true;
            resultsSection.classList.add('hidden');
            progressSection.classList.remove('hidden');
            bulkProgressDetails.classList.remove('hidden');
            bulkResults.classList.remove('hidden');
            singleResults.classList.add('hidden');
            bulkResultsBody.innerHTML = '';
            exportBtn.classList.remove('hidden');
            
            startTime = new Date();
            updateProgress();
            
            // Process prospects sequentially
            processBulkProspects();
        }
        
        // Process bulk prospects
        async function processBulkProspects() {
            for (let i = 0; i < bulkData.length; i++) {
                currentProspectIndex = i;
                const prospect = bulkData[i];
                
                // Update current prospect display
                currentProspect.textContent = `Processing: ${prospect.firstName} ${prospect.lastName}`;
                prospectProgress.textContent = `Prospect ${i + 1} of ${bulkData.length}`;
                
                // Generate URL patterns for this prospect
                const urlPatterns = generateUrlPatterns(
                    prospect.firstName.toLowerCase(),
                    prospect.lastName.toLowerCase(),
                    prospect.company.toLowerCase()
                );
                
                // Find valid URLs for this prospect
                const prospectValidUrls = [];
                await validateUrlsInBatches(urlPatterns, 3, 300, null, prospectValidUrls);
                
                // Store results
                bulkResults.push({
                    ...prospect,
                    validUrls: prospectValidUrls,
                    status: prospectValidUrls.length > 0 ? 'found' : 'none'
                });
                
                // Update bulk results table
                updateBulkResultsTable();
                
                // Small delay between prospects
                if (i < bulkData.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            finishBulkSearch();
        }
        
        // Update bulk results table
        function updateBulkResultsTable() {
            bulkResultsBody.innerHTML = '';
            
            bulkResults.forEach(result => {
                const row = document.createElement('tr');
                row.className = 'border-t hover:bg-gray-50';
                
                const linksHtml = result.validUrls.length > 0 
                    ? result.validUrls.map(item => `
                        <div class="mb-1">
                            <a href="${item.url}" target="_blank" class="text-primary text-sm hover:underline">${item.url}</a>
                            <button class="ml-2 text-xs text-gray-500 hover:text-gray-700" onclick="copyToClipboard('${item.url}')">
                                <i class="far fa-copy"></i>
                            </button>
                        </div>
                    `).join('')
                    : '<span class="text-gray-400 text-sm">No links found</span>';
                
                const statusIcon = result.status === 'found' 
                    ? '<i class="fas fa-check-circle text-green-500"></i>'
                    : '<i class="fas fa-times-circle text-red-500"></i>';
                
                row.innerHTML = `
                    <td class="py-3 px-4">
                        <div class="font-medium text-gray-900">${result.firstName} ${result.lastName}</div>
                    </td>
                    <td class="py-3 px-4 text-gray-600">${result.company || '-'}</td>
                    <td class="py-3 px-4 max-w-md">
                        <div class="max-h-24 overflow-y-auto">
                            ${linksHtml}
                        </div>
                    </td>
                    <td class="py-3 px-4 text-center">${statusIcon}</td>
                `;
                
                bulkResultsBody.appendChild(row);
            });
        }
        
        // Generate URL patterns
        function generateUrlPatterns(firstName, lastName, companyName) {
            const patterns = [];
            
            const cleanFirstName = firstName.replace(/[^a-z0-9]/g, '');
            const cleanLastName = lastName.replace(/[^a-z0-9]/g, '');
            const cleanCompanyName = companyName.replace(/[^a-z0-9]/g, '');
            
            const namePatterns = [
                `${cleanFirstName}`,
                `${cleanLastName}`,
                `${cleanFirstName}${cleanLastName}`,
                `${cleanLastName}${cleanFirstName}`,
                `${cleanFirstName}.${cleanLastName}`,
                `${cleanLastName}.${cleanFirstName}`,
                `${cleanFirstName}-${cleanLastName}`,
                `${cleanLastName}-${cleanFirstName}`,
                `${cleanFirstName}_${cleanLastName}`,
                `${cleanLastName}_${cleanFirstName}`,
                `${cleanFirstName.charAt(0)}${cleanLastName}`,
                `${cleanFirstName}${cleanLastName.charAt(0)}`,
                `${cleanFirstName.charAt(0)}.${cleanLastName}`,
                `${cleanFirstName.charAt(0)}-${cleanLastName}`,
                `${cleanFirstName.charAt(0)}_${cleanLastName}`,
                `${cleanFirstName}-${cleanLastName.charAt(0)}`,
                `${cleanFirstName}.${cleanLastName.charAt(0)}`,
                `${cleanFirstName}_${cleanLastName.charAt(0)}`
            ];
            
            namePatterns.forEach(pattern => {
                patterns.push({
                    url: `https://calendly.com/${pattern}`,
                    pattern: pattern
                });
            });
            
            if (companyName) {
                patterns.push({
                    url: `https://calendly.com/${cleanCompanyName}`,
                    pattern: cleanCompanyName
                });
                
                namePatterns.forEach(pattern => {
                    const combinedPatterns = [
                        `${pattern}-${cleanCompanyName}`,
                        `${cleanCompanyName}-${pattern}`,
                        `${pattern}.${cleanCompanyName}`,
                        `${cleanCompanyName}.${pattern}`,
                        `${pattern}_${cleanCompanyName}`,
                        `${cleanCompanyName}_${pattern}`
                    ];
                    
                    combinedPatterns.forEach(combined => {
                        patterns.push({
                            url: `https://calendly.com/${combined}`,
                            pattern: combined
                        });
                    });
                });
            }
            
            return patterns;
        }
        
        // Validate URLs in batches
        async function validateUrlsInBatches(urlPatterns, batchSize, delay, callback, validUrlsArray = null) {
            const targetArray = validUrlsArray || validUrls;
            
            for (let i = 0; i < urlPatterns.length; i += batchSize) {
                const batch = urlPatterns.slice(i, i + batchSize);
                
                const promises = batch.map(item => validateUrl(item.url, item.pattern));
                const results = await Promise.all(promises);
                
                results.forEach((isValid, index) => {
                    if (isValid) {
                        targetArray.push({
                            url: batch[index].url,
                            pattern: batch[index].pattern
                        });
                    }
                    testedUrls++;
                    updateProgress();
                });
                
                if (i + batchSize < urlPatterns.length) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            if (callback) callback();
        }
        
        // Update progress
        function updateProgress() {
            const percent = Math.round((testedUrls / totalUrls) * 100);
            progressBar.style.width = `${percent}%`;
            progressFraction.textContent = `${testedUrls}/${totalUrls}`;
            progressText.textContent = testedUrls === totalUrls 
                ? `Finishing up...` 
                : `Testing URLs...`;
        }
        
        // Finish single search
        function finishSingleSearch() {
            const endTime = new Date();
            const timeTaken = (endTime - startTime) / 1000;
            resultsTime.textContent = `Found ${validUrls.length} links in ${timeTaken.toFixed(1)} seconds`;
            
            progressSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            
            btnText.textContent = 'Find Calendly Links';
            spinner.classList.add('hidden');
            searchBtn.disabled = false;
            
            displaySingleResults();
        }
        
        // Finish bulk search
        function finishBulkSearch() {
            const endTime = new Date();
            const timeTaken = (endTime - startTime) / 1000;
            const totalFound = bulkResults.reduce((sum, result) => sum + result.validUrls.length, 0);
            resultsTime.textContent = `Found ${totalFound} links across ${bulkResults.length} prospects in ${timeTaken.toFixed(1)} seconds`;
            
            progressSection.classList.add('hidden');
            resultsSection.classList.remove('hidden');
            
            bulkBtnText.textContent = `Find Links for ${bulkData.length} Prospects`;
            bulkSpinner.classList.add('hidden');
            bulkSearchBtn.disabled = false;
            
            if (totalFound === 0) {
                emptyResults.classList.remove('hidden');
                bulkResults.classList.add('hidden');
            } else {
                emptyResults.classList.add('hidden');
            }
        }
        
        // Display single search results
        function displaySingleResults() {
            if (validUrls.length === 0) {
                emptyResults.classList.remove('hidden');
                singleResults.innerHTML = '';
                return;
            }
            
            emptyResults.classList.add('hidden');
            singleResults.innerHTML = '';
            
            validUrls.forEach(item => {
                const resultElement = document.createElement('div');
                resultElement.className = 'link-item bg-white border rounded-lg p-4 flex flex-col sm:flex-row sm:items-center justify-between';
                
                resultElement.innerHTML = `
                    <div class="mb-3 sm:mb-0 sm:mr-4">
                        <div class="flex items-center">
                            <div class="bg-green-100 w-10 h-10 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                                <i class="fas fa-calendar-check text-green-600"></i>
                            </div>
                            <div>
                                <a href="${item.url}" target="_blank" class="text-primary font-medium hover:underline">${item.url}</a>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    <span class="pattern-tag px-2 py-0.5 rounded">${item.pattern}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn-copy bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition flex items-center" data-url="${item.url}">
                        <i class="far fa-copy mr-2"></i> Copy
                    </button>
                `;
                
                singleResults.appendChild(resultElement);
            });
            
            // Add copy button functionality
            document.querySelectorAll('.btn-copy').forEach(button => {
                button.addEventListener('click', () => {
                    const url = button.getAttribute('data-url');
                    copyToClipboard(url);
                    
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check mr-2"></i> Copied!';
                    button.disabled = true;
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                });
            });
        }
        
        // Export results to CSV
        function exportResults() {
            if (bulkResults.length === 0) return;
            
            const csvData = bulkResults.map(result => ({
                'First Name': result.firstName,
                'Last Name': result.lastName,
                'Company': result.company || '',
                'Found Links': result.validUrls.map(item => item.url).join('; '),
                'Link Count': result.validUrls.length,
                'Status': result.status === 'found' ? 'Links Found' : 'No Links Found'
            }));
            
            const csv = Papa.unparse(csvData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `calendly_results_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        // Copy to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }
        
        // Validate Calendly URL
        async function validateUrl(url, pattern) {
            const proxies = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                `https://corsproxy.io/?${encodeURIComponent(url)}`,
                `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
            ];
            
            for (const proxyUrl of proxies) {
                try {
                    const response = await Promise.race([
                        fetch(proxyUrl, {
                            headers: {
                                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                            }
                        }),
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout')), 10000)
                        )
                    ]);
                    
                    if (!response.ok) continue;
                    
                    const html = await response.text();
                    const htmlLower = html.toLowerCase();
                    
                    const invalidIndicators = [
                        'this calendly link is not available',
                        'page not found',
                        '404',
                        'not found',
                        'does not exist',
                        'invalid link',
                        'this link is no longer available',
                        '<title>calendly - page not found</title>',
                        'calendly-404',
                        'error-page'
                    ];
                    
                    for (const indicator of invalidIndicators) {
                        if (htmlLower.includes(indicator)) {
                            return false;
                        }
                    }
                    
                    const validIndicators = [
                        'calendly-inline-widget',
                        'scheduling',
                        'book a time',
                        'select a date',
                        'available times'
                    ];
                    
                    for (const indicator of validIndicators) {
                        if (htmlLower.includes(indicator)) {
                            return true;
                        }
                    }
                    
                    return false;
                    
                } catch (error) {
                    console.warn(`Proxy failed for ${url}:`, error);
                }
            }
            
            return false;
        }
    </script>
</body>
</html>
